<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birmingham 1410 - Chronicle Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .legend {
            background: rgba(20, 20, 20, 0.95);
            padding: 15px;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 12px;
            line-height: 18px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            max-width: 220px;
        }
        
        .legend h3 {
            margin: 0 0 8px 0;
            color: #f0f0f0;
            font-size: 14px;
            border-bottom: 2px solid #666;
            padding-bottom: 4px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .legend-symbol {
            width: 20px;
            margin-right: 6px;
            text-align: center;
        }
        
        .custom-popup {
            font-size: 13px;
            line-height: 1.4;
            max-width: 280px;
        }
        
        .custom-popup h4 {
            margin: 0 0 6px 0;
            color: #333;
            border-bottom: 2px solid #666;
            padding-bottom: 3px;
        }
        
        .popup-detail {
            margin: 3px 0;
            color: #555;
        }
        
        .popup-souls {
            font-weight: bold;
            color: #8b0000;
        }
        
        .popup-travel {
            color: #666;
            margin-top: 4px;
        }
        
        .popup-walking {
            font-style: italic;
        }
        
        .popup-riding {
            font-style: italic;
            color: #4169e1;
        }
        
        .popup-type {
            color: #008080;
            font-weight: bold;
        }
        
        .leaflet-container {
            background: #1a1a1a;
        }
        
        .covenant-boundary {
            stroke: #9400d3;
            stroke-width: 3;
            stroke-opacity: 0.7;
            fill: #9400d3;
            fill-opacity: 0.15;
            stroke-dasharray: 10, 5;
        }
        
        .forest-arden {
            stroke: #228b22;
            stroke-width: 2;
            stroke-opacity: 0.7;
            fill: #228b22;
            fill-opacity: 0.1;
        }
        
        .layer-control-buttons {
            position: absolute;
            top: 10px;
            right: 320px;
            z-index: 1000;
            background: rgba(20, 20, 20, 0.95);
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #444;
        }
        
        .layer-control-buttons button {
            margin: 0 5px;
            padding: 5px 10px;
            background: #444;
            color: #fff;
            border: 1px solid #666;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .layer-control-buttons button:hover {
            background: #555;
        }
        
        .basemap-control {
            position: absolute;
            top: 55px;
            right: 320px;
            z-index: 1000;
            background: rgba(20, 20, 20, 0.95);
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #444;
        }
        
        .basemap-control select {
            padding: 5px;
            background: #333;
            color: #fff;
            border: 1px solid #666;
            border-radius: 3px;
        }
        
        .distance-calculator {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(20, 20, 20, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
            color: #e0e0e0;
            width: 250px;
        }
        
        .distance-calculator h4 {
            margin: 0 0 10px 0;
            color: #f0f0f0;
            border-bottom: 1px solid #666;
            padding-bottom: 5px;
        }
        
        .distance-calculator button {
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background: #444;
            color: #fff;
            border: 1px solid #666;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .distance-calculator button:hover {
            background: #555;
        }
        
        .distance-calculator button.active {
            background: #4169e1;
        }
        
        .distance-result {
            margin-top: 10px;
            padding: 10px;
            background: #333;
            border-radius: 3px;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .distance-points {
            margin: 5px 0;
            padding: 5px;
            background: #2a2a2a;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .emoji-marker {
            font-size: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            background: white;
            border: 2px solid black;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="layer-control-buttons">
        <button id="select-all">Select All</button>
        <button id="deselect-all">Deselect All</button>
    </div>
    
    <div class="basemap-control">
        <select id="basemap-select">
            <option value="satellite">Satellite</option>
            <option value="terrain">Terrain</option>
            <option value="street">Street</option>
        </select>
    </div>
    
    <div class="distance-calculator">
        <h4>‚è±Ô∏è Travel Time Calculator</h4>
        <div class="distance-points">
            <div id="point-from">From: <em>Click "Select Start"</em></div>
            <div id="point-to">To: <em>Click "Select End"</em></div>
        </div>
        <button id="select-from">üìç Select Start Point</button>
        <button id="select-to">üéØ Select End Point</button>
        <button id="clear-selection">‚ùå Clear</button>
        <div id="distance-result" class="distance-result" style="display: none;"></div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on Birmingham
        const map = L.map('map', {
            center: [52.4862, -1.8904],
            zoom: 11,
            minZoom: 6,
            maxZoom: 18
        });
        
        // Travel time calculator state
        let selectingFrom = false;
        let selectingTo = false;
        let fromPoint = null;
        let toPoint = null;
        let fromMarker = null;
        let toMarker = null;
        let pathLine = null;
        
        // Define base layers
        const baseLayers = {
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '&copy; Esri'
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenTopoMap'
            }),
            street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            })
        };
        
        // Add default layer
        baseLayers.satellite.addTo(map);
        
        // Add street names overlay
        const labelLayer = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}{r}.png', {
            attribution: 'Map labels by Stamen Design',
            subdomains: 'abcd',
            opacity: 0.7
        }).addTo(map);
        
        // Basemap selector
        document.getElementById('basemap-select').addEventListener('change', function(e) {
            for (let key in baseLayers) {
                map.removeLayer(baseLayers[key]);
            }
            baseLayers[e.target.value].addTo(map);
            labelLayer.bringToFront();
        });
        
        // Calculate east shift for Birmingham locations
        const eastShift = 0.004;
        
        // Define custom emoji icons
        const createEmojiIcon = (emoji, size = 24) => {
            return L.divIcon({
                html: `<div class="emoji-marker">${emoji}</div>`,
                iconSize: [size, size],
                iconAnchor: [size/2, size/2],
                popupAnchor: [0, -size/2],
                className: 'emoji-icon'
            });
        };
        
        const birminghamBuildingIcon = createEmojiIcon('üèõÔ∏è');
        const settlementIcon = createEmojiIcon('üèòÔ∏è', 20);
        const regionalTownIcon = createEmojiIcon('üè∞', 22);
        const majorCityIcon = createEmojiIcon('üèôÔ∏è', 26);
        const havenIcon = createEmojiIcon('üõ°Ô∏è', 22);
        const religiousIcon = createEmojiIcon('‚õ™', 20);
        const faeIcon = createEmojiIcon('üßö', 20);
        const infrastructureIcon = createEmojiIcon('‚öôÔ∏è', 18);
        const poiIcon = createEmojiIcon('üìç', 18);
        const forestPoiIcon = createEmojiIcon('üå≤', 20);
        
        // Layer groups
        const covenantLayer = L.layerGroup();
        const birminghamBuildingsLayer = L.layerGroup();
        const havensLayer = L.layerGroup();
        const religiousLayer = L.layerGroup();
        const faeLayer = L.layerGroup();
        const infrastructureLayer = L.layerGroup();
        const poisLayer = L.layerGroup();
        const forestPoisLayer = L.layerGroup();
        const settlementsLayer = L.layerGroup();
        const regionalLayer = L.layerGroup();
        const majorCitiesLayer = L.layerGroup();
        const forestLayer = L.layerGroup();
        
        // Extended covenant points to include Gunnar's Barrow
        const covenantPoints = [
            {lat: 52.499, lng: -1.884},
            {lat: 52.471, lng: -1.877},
            {lat: 52.445, lng: -1.885},
            {lat: 52.477, lng: -1.935},
            {lat: 52.507, lng: -1.924},
            {lat: 52.4510, lng: -1.9384},
            {lat: 52.525, lng: -1.880}
        ];
        
        // Draw Covenant boundary
        const covenantRadius = 2011.68;
        let boundaryPoints = [];
        covenantPoints.forEach(center => {
            for (let angle = 0; angle < 360; angle += 10) {
                const lat = center.lat + (covenantRadius / 111320) * Math.cos(angle * Math.PI / 180);
                const lng = center.lng + (covenantRadius / (111320 * Math.cos(center.lat * Math.PI / 180))) * Math.sin(angle * Math.PI / 180);
                boundaryPoints.push([lat, lng]);
            }
        });
        
        function convexHull(points) {
            points.sort((a, b) => a[0] - b[0] || a[1] - b[1]);
            const lower = [];
            for (let i = 0; i < points.length; i++) {
                while (lower.length >= 2 && cross(lower[lower.length - 2], lower[lower.length - 1], points[i]) <= 0) {
                    lower.pop();
                }
                lower.push(points[i]);
            }
            const upper = [];
            for (let i = points.length - 1; i >= 0; i--) {
                while (upper.length >= 2 && cross(upper[upper.length - 2], upper[upper.length - 1], points[i]) <= 0) {
                    upper.pop();
                }
                upper.push(points[i]);
            }
            upper.pop();
            lower.pop();
            return lower.concat(upper);
            
            function cross(O, A, B) {
                return (A[0] - O[0]) * (B[1] - O[1]) - (A[1] - O[1]) * (B[0] - O[0]);
            }
        }
        
        const covenantBoundary = convexHull(boundaryPoints);
        L.polygon(covenantBoundary, {
            className: 'covenant-boundary'
        }).bindPopup('<div class="custom-popup"><h4>The Covenant Boundary</h4><div class="popup-detail">Supernatural protection extends throughout this area</div></div>')
          .addTo(covenantLayer);
        
        // Forest of Arden
        const ardenBounds = [
            [52.65, -2.65],
            [52.65, -1.48],
            [51.90, -1.48],
            [51.90, -2.65]
        ];
        
        L.rectangle(ardenBounds, {
            color: '#228b22',
            weight: 2,
            opacity: 0.6,
            fillColor: '#228b22',
            fillOpacity: 0.1,
            className: 'forest-arden'
        }).bindPopup('<div class="custom-popup"><h4>Forest of Arden</h4><div class="popup-detail">Ancient woodland spanning the heart of England</div><div class="popup-type">Gunnar\'s Domain</div></div>')
          .addTo(forestLayer);
        
        // Birmingham Buildings
        const birminghamBuildings = [
            {name: "St. Martin's Church", lat: 52.4770, lng: -1.8976 + eastShift, detail: "Parish church"},
            {name: "Bull Ring Market", lat: 52.4768, lng: -1.8974 + eastShift, detail: "Triangular market space"},
            {name: "De Birmingham Manor", lat: 52.479, lng: -1.900 + eastShift, detail: "Moated manor complex on Moat Lane"},
            {name: "Guild of the Holy Cross Hall", lat: 52.4785, lng: -1.8945 + eastShift, detail: "Guild meeting hall"},
            {name: "Market Cross", lat: 52.4768, lng: -1.8975 + eastShift, detail: "Town center"},
            {name: "Stocks & Pillory", lat: 52.4767, lng: -1.8973 + eastShift, detail: "Justice and punishment"},
            {name: "The Shambles", lat: 52.4775, lng: -1.8970 + eastShift, detail: "Butchers' quarter"},
            {name: "The Old Crown", lat: 52.476, lng: -1.892 + eastShift, detail: "Tavern in Deritend/Digbeth"},
            {name: "Silver Swan Inn", lat: 52.478, lng: -1.894 + eastShift, detail: "Moor Street inn"},
            {name: "Master Woolmonger's House", lat: 52.478, lng: -1.895 + eastShift, detail: "Wealthy merchant residence"},
            {name: "Master John Smith's Forge", lat: 52.475, lng: -1.895 + eastShift, detail: "Digbeth smithy"},
            {name: "Master Wilhelm's Silver Workshop", lat: 52.476, lng: -1.896 + eastShift, detail: "Digbeth workshop"},
            {name: "Thomas Ironwright's Smithy", lat: 52.475, lng: -1.897 + eastShift, detail: "New Street area"}
        ];
        
        birminghamBuildings.forEach(loc => {
            L.marker([loc.lat, loc.lng], {icon: birminghamBuildingIcon})
                .bindPopup(`<div class="custom-popup"><h4>${loc.name}</h4><div class="popup-detail">${loc.detail}</div></div>`)
                .addTo(birminghamBuildingsLayer);
        });
        
        // Character Havens
        const havens = [
            {name: "Gunnar's Barrow", lat: 52.520, lng: -1.880, detail: "Ancient burial mound, 3 miles north in Arden", time: "20 min to town"},
            {name: "Elizabeth's Tower", lat: 52.4815, lng: -1.9015 + eastShift, detail: "Within De Birmingham Manor complex", time: "5 min to Bull Ring"},
            {name: "Marcus's Laboratory", lat: 52.478, lng: -1.895 + eastShift, detail: "Secret haven beneath Woolmonger's house", time: "3 min to Bull Ring"},
            {name: "Lucian's Crypt", lat: 52.4770, lng: -1.8976 + eastShift, detail: "Beneath St. Martin's Church", time: "In town center"},
            {name: "Morganna's Roman Villa", lat: 52.450, lng: -1.900, detail: "Ancient ruins, 2 miles south", time: "40 min walk to town"}
        ];
        
        havens.forEach(haven => {
            L.marker([haven.lat, haven.lng], {icon: havenIcon})
                .bindPopup(`<div class="custom-popup"><h4>${haven.name}</h4><div class="popup-detail">${haven.detail}</div><div class="popup-distance">${haven.time}</div></div>`)
                .addTo(havensLayer);
        });
        
        // Religious Buildings
        const religious = [
            {name: "St. Thomas's Priory", lat: 52.482, lng: -1.895, detail: "House of Augustinian canons, established by De Birminghams"}
        ];
        
        religious.forEach(loc => {
            L.marker([loc.lat, loc.lng], {icon: religiousIcon})
                .bindPopup(`<div class="custom-popup"><h4>${loc.name}</h4><div class="popup-detail">${loc.detail}</div></div>`)
                .addTo(religiousLayer);
        });
        
        // Fae Sacred Sites & Refugee Camps
        const faeSites = [
            {name: "The Standing Stones", lat: 52.477, lng: -1.875, detail: "1 mile east, neutral ground"},
            {name: "The Hollow Oak", lat: 52.505, lng: -1.875, detail: "Ancient oak in Arden, wedding venue"},
            {name: "The Heart Oak", lat: 52.565, lng: -1.870, detail: "Deep Arden, Old Man of the Wood"},
            {name: "Northern Forest Camp", lat: 52.495, lng: -1.895, detail: "Fae refugee camp"},
            {name: "Eastern Heath Camp", lat: 52.475, lng: -1.870, detail: "Fae refugee camp"},
            {name: "Southern Valley Camp", lat: 52.455, lng: -1.900, detail: "Fae refugee camp"},
            {name: "Western Woods Camp", lat: 52.470, lng: -1.920, detail: "Fae refugee camp"},
            {name: "River Bend Camp", lat: 52.465, lng: -1.885, detail: "Fae refugee camp"}
        ];
        
        faeSites.forEach(site => {
            L.marker([site.lat, site.lng], {icon: faeIcon})
                .bindPopup(`<div class="custom-popup"><h4>${site.name}</h4><div class="popup-detail">${site.detail}</div></div>`)
                .addTo(faeLayer);
        });
        
        // Forest Points of Interest
        const forestPois = [
            {name: "Moonlit Grove", lat: 52.535, lng: -1.920, detail: "Sacred clearing, fae dancing circle"},
            {name: "Hunter's Rest", lat: 52.510, lng: -1.960, detail: "Ancient waystation, outlaws' meeting place"},
            {name: "Whispering Stones", lat: 52.545, lng: -1.850, detail: "Pre-Roman stone circle, voices on the wind"},
            {name: "Dead Man's Clearing", lat: 52.490, lng: -1.940, detail: "Site of ancient battle, restless spirits"},
            {name: "Silver Spring", lat: 52.525, lng: -1.890, detail: "Pure water source, healing properties"},
            {name: "The Watcher's Tree", lat: 52.555, lng: -1.880, detail: "Giant oak, ravens nest here"},
            {name: "Mushroom Dell", lat: 52.500, lng: -1.910, detail: "Fairy rings, dangerous to enter"},
            {name: "Wolf's Hollow", lat: 52.530, lng: -1.865, detail: "Werewolf hunting grounds"},
            {name: "Hermit's Cave", lat: 52.515, lng: -1.935, detail: "Abandoned dwelling, strange writings"},
            {name: "The Crossroads", lat: 52.505, lng: -1.885, detail: "Where three ancient paths meet"},
            {name: "Hanging Tree", lat: 52.495, lng: -1.870, detail: "Justice tree, criminals hung here"},
            {name: "Druid's Pool", lat: 52.540, lng: -1.905, detail: "Dark water, sacrificial site"},
            {name: "Broken Tower", lat: 52.520, lng: -1.845, detail: "Ruined watchtower, good vantage"},
            {name: "The Green Chapel", lat: 52.485, lng: -1.855, detail: "Nature shrine, pre-Christian"},
            {name: "Starfall Meadow", lat: 52.550, lng: -1.915, detail: "Open glade, meteor iron found here"}
        ];
        
        forestPois.forEach(poi => {
            L.marker([poi.lat, poi.lng], {icon: forestPoiIcon})
                .bindPopup(`<div class="custom-popup"><h4>${poi.name}</h4><div class="popup-detail">${poi.detail}</div></div>`)
                .addTo(forestPoisLayer);
        });
        
        // Infrastructure
        const infrastructure = [
            {name: "Town Mill", lat: 52.473, lng: -1.893 + eastShift, detail: "On River Rea, Digbeth"},
            {name: "Common Grazing", lat: 52.465, lng: -1.900, detail: "South of town"},
            {name: "Quarry", lat: 52.475, lng: -1.920, detail: "West, sandstone source"},
            {name: "Archery Butts", lat: 52.480, lng: -1.870, detail: "East training ground"},
            {name: "Gallows Hill", lat: 52.490, lng: -1.900, detail: "North execution site"}
        ];
        
        infrastructure.forEach(site => {
            L.marker([site.lat, site.lng], {icon: infrastructureIcon})
                .bindPopup(`<div class="custom-popup"><h4>${site.name}</h4><div class="popup-detail">${site.detail}</div></div>`)
                .addTo(infrastructureLayer);
        });
        
        // Points of Interest
        const pointsOfInterest = [
            {name: "Aston Mill Roman Ruins", lat: 52.499, lng: -1.884, detail: "Ancient Roman fortification ruins"},
            {name: "Bordesley Abbey Ruins", lat: 52.471, lng: -1.877, detail: "Roman temple foundations"},
            {name: "Moseley Bog Roman Fort", lat: 52.445, lng: -1.885, detail: "Roman outpost ruins"},
            {name: "Harborne Hill Roman Villa", lat: 52.477, lng: -1.935, detail: "Roman villa ruins"},
            {name: "Handsworth Grove Roman Shrine", lat: 52.507, lng: -1.924, detail: "Roman sacred grove ruins"},
            {name: "Metchley Fort Roman Ruins", lat: 52.4510, lng: -1.9384, detail: "Main Roman fort ruins"},
            {name: "Old Saxon Meeting Stone", lat: 52.485, lng: -1.895, detail: "Pre-conquest gathering place"},
            {name: "Small Norman Tower", lat: 52.492, lng: -1.878, detail: "Ruined watchtower"},
            {name: "Holy Well of St. Chad", lat: 52.495, lng: -1.865, detail: "Healing spring"},
            {name: "Old Stone Bridge", lat: 52.473, lng: -1.885, detail: "Roman foundations"},
            {name: "Leper Hospital", lat: 52.462, lng: -1.895, detail: "St. Lazarus foundation"},
            {name: "Iron Bloomery", lat: 52.498, lng: -1.888, detail: "Aston ironworks"},
            {name: "Tanners' Quarter", lat: 52.472, lng: -1.892 + eastShift, detail: "Leather working"},
            {name: "Mill Pool", lat: 52.477, lng: -1.906, detail: "Dammed river for power"},
            {name: "Charcoal Burners' Camp", lat: 52.455, lng: -1.925, detail: "Forest edge settlement"},
            {name: "Roman Road Junction", lat: 52.468, lng: -1.888, detail: "Ryknild & Watling Street"},
            {name: "Plague Pit", lat: 52.463, lng: -1.912, detail: "1350s burial ground"},
            {name: "Hermit's Cell", lat: 52.488, lng: -1.865, detail: "Anchorite dwelling"},
            {name: "Get of Fenris Den", lat: 52.525, lng: -1.875, detail: "Werewolf pack territory"},
            {name: "Northwest Logging Camp", lat: 52.515, lng: -1.920, detail: "Lichfield road"},
            {name: "Northeast Logging Camp", lat: 52.510, lng: -1.850, detail: "Tamworth road"},
            {name: "East Logging Camp", lat: 52.485, lng: -1.845, detail: "Coventry road"}
        ];
        
        pointsOfInterest.forEach(poi => {
            L.marker([poi.lat, poi.lng], {icon: poiIcon})
                .bindPopup(`<div class="custom-popup"><h4>${poi.name}</h4><div class="popup-detail">${poi.detail}</div></div>`)
                .addTo(poisLayer);
        });
        
        // Local settlements
        const settlements = [
            {name: "Aston", lat: 52.506, lng: -1.890, souls: "600-800", time: "30 min walk"},
            {name: "Erdington", lat: 52.520, lng: -1.840, souls: "300-400", time: "1 hour walk"},
            {name: "Yardley", lat: 52.475, lng: -1.810, souls: "400-500", time: "1.5 hours walk"},
            {name: "Handsworth", lat: 52.507, lng: -1.924, souls: "250-350", time: "45 min walk"},
            {name: "Edgbaston", lat: 52.465, lng: -1.925, souls: "200-300", time: "45 min walk"},
            {name: "Witton", lat: 52.515, lng: -1.885, souls: "150-200", time: "45 min walk"},
            {name: "Selly Oak", lat: 52.438, lng: -1.936, souls: "100-150", time: "1 hour walk"},
            {name: "King's Norton", lat: 52.416, lng: -1.900, souls: "300-400", time: "2 hours walk"},
            {name: "Northfield", lat: 52.411, lng: -1.964, souls: "250-300", time: "2.5 hours walk"},
            {name: "Sutton Coldfield", lat: 52.5704, lng: -1.8240, souls: "500-700", time: "3 hours walk"},
            {name: "Solihull", lat: 52.4143, lng: -1.7809, souls: "400-500", time: "3 hours walk"}
        ];
        
        settlements.forEach(settlement => {
            L.marker([settlement.lat, settlement.lng], {icon: settlementIcon})
                .bindPopup(`<div class="custom-popup"><h4>${settlement.name}</h4><div class="popup-souls">Population: ${settlement.souls} souls</div><div class="popup-distance">${settlement.time}</div></div>`)
                .addTo(settlementsLayer);
        });
        
        // Regional towns
        const regionalTowns = [
            {name: "Coventry", lat: 52.4081, lng: -1.5106, souls: "6,000-8,000", walking: "1 day", riding: "4-5 hours", note: "Major trade center, within Forest of Arden"},
            {name: "Lichfield", lat: 52.6835, lng: -1.8266, souls: "2,000", walking: "1 day", riding: "3-4 hours", note: "Cathedral city"},
            {name: "Warwick", lat: 52.2832, lng: -1.5849, souls: "2,000-2,500", walking: "1 day", riding: "4-5 hours", note: "County town, within Forest of Arden"},
            {name: "Tamworth", lat: 52.6340, lng: -1.6959, souls: "1,500", walking: "5-6 hours", riding: "2-3 hours", note: "Former Mercian capital"},
            {name: "Worcester", lat: 52.1894, lng: -2.2200, souls: "3,000", walking: "1.5-2 days", riding: "6-8 hours", note: "Cathedral city, River Severn port"},
            {name: "Leicester", lat: 52.6369, lng: -1.1398, souls: "3,000", walking: "1.5-2 days", riding: "6-8 hours", note: "Major wool market"},
            {name: "Nottingham", lat: 52.9548, lng: -1.1581, souls: "3,000", walking: "2 days", riding: "8-10 hours", note: "Castle and market town"},
            {name: "Shrewsbury", lat: 52.7073, lng: -2.7527, souls: "3,000", walking: "2 days", riding: "8-10 hours", note: "Welsh border fortress"},
            {name: "Hereford", lat: 52.0565, lng: -2.7160, souls: "2,000", walking: "2 days", riding: "1 day", note: "Cathedral city, Welsh marches"},
            {name: "Gloucester", lat: 51.8642, lng: -2.2382, souls: "2,500", walking: "2 days", riding: "8-10 hours", note: "Abbey town, River Severn crossing"},
            {name: "Derby", lat: 52.9225, lng: -1.4746, souls: "1,500", walking: "1.5 days", riding: "6-7 hours", note: "Market town"},
            {name: "Stafford", lat: 52.8066, lng: -2.1159, souls: "1,200", walking: "1 day", riding: "4-5 hours", note: "County town"}
        ];
        
        regionalTowns.forEach(town => {
            const popupContent = `
                <div class="custom-popup">
                    <h4>${town.name}</h4>
                    <div class="popup-souls">Population: ${town.souls} souls</div>
                    <div class="popup-travel">
                        <div class="popup-walking">Walking: ${town.walking}</div>
                        <div class="popup-riding">Riding: ${town.riding}</div>
                    </div>
                    ${town.note ? `<div class="popup-detail">${town.note}</div>` : ''}
                </div>
            `;
            L.marker([town.lat, town.lng], {icon: regionalTownIcon})
                .bindPopup(popupContent)
                .addTo(regionalLayer);
        });
        
        // Major cities
        const majorCities = [
            {name: "London", lat: 51.5074, lng: -0.1278, souls: "35,000-40,000", walking: "4-5 days", riding: "2 days", note: "Capital of England, Mithras's domain"},
            {name: "York", lat: 53.9591, lng: -1.0815, souls: "8,000-10,000", walking: "4-5 days", riding: "2 days", note: "Second city of England, Archbishop's seat"},
            {name: "Bristol", lat: 51.4545, lng: -2.5879, souls: "8,000-10,000", walking: "2-3 days", riding: "1 day", note: "Major western port, Atlantic trade"},
            {name: "Norwich", lat: 52.6309, lng: 1.2974, souls: "7,000-8,000", walking: "5-6 days", riding: "2-3 days", note: "East Anglia's capital, wool trade center"},
            {name: "Oxford", lat: 51.7520, lng: -1.2577, souls: "4,000", walking: "2 days", riding: "1 day", note: "University town, center of learning"},
            {name: "Chester", lat: 53.1930, lng: -2.8930, souls: "3,000", walking: "2-3 days", riding: "1 day", note: "Border fortress, Irish Sea port"},
            {name: "Lincoln", lat: 53.2307, lng: -0.5406, souls: "4,000", walking: "3 days", riding: "1-1.5 days", note: "Cathedral city, wool staple"},
            {name: "Canterbury", lat: 51.2802, lng: 1.0789, souls: "3,000", walking: "5-6 days", riding: "2-3 days", note: "Pilgrimage center, Archbishop's seat"},
            {name: "Winchester", lat: 51.0632, lng: -1.3080, souls: "2,000", walking: "4 days", riding: "2 days", note: "Former capital, cathedral city"},
            {name: "Salisbury", lat: 51.0693, lng: -1.7957, souls: "3,500", walking: "3-4 days", riding: "1.5-2 days", note: "Cathedral city, cloth market"},
            {name: "Exeter", lat: 50.7184, lng: -3.5339, souls: "3,000", walking: "5-6 days", riding: "2-3 days", note: "Devon capital, tin trade"},
            {name: "Newcastle", lat: 54.9783, lng: -1.6178, souls: "5,000-6,000", walking: "6-7 days", riding: "3 days", note: "Northern stronghold, coal trade"}
        ];
        
        majorCities.forEach(city => {
            const popupContent = `
                <div class="custom-popup">
                    <h4>${city.name}</h4>
                    <div class="popup-souls">Population: ${city.souls} souls</div>
                    <div class="popup-travel">
                        <div class="popup-walking">Walking: ${city.walking}</div>
                        <div class="popup-riding">Riding: ${city.riding}</div>
                    </div>
                    <div class="popup-detail">${city.note}</div>
                </div>
            `;
            L.marker([city.lat, city.lng], {icon: majorCityIcon})
                .bindPopup(popupContent)
                .addTo(majorCitiesLayer);
        });
        
        // Calculate walking time between two points
        function calculateWalkingTime(lat1, lng1, lat2, lng2) {
            // Calculate distance in km using Haversine formula
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            // Convert to miles
            const miles = distance * 0.621371;
            
            // Medieval walking speed: ~20-25 miles per day, 3 mph average
            const hours = miles / 3;
            const days = Math.floor(hours / 10); // 10 hours walking per day
            const remainingHours = Math.round(hours % 10);
            
            // Format output
            if (days > 0) {
                if (remainingHours > 0) {
                    return {
                        walking: `${days} day${days > 1 ? 's' : ''}, ${remainingHours} hour${remainingHours > 1 ? 's' : ''}`,
                        riding: `${Math.ceil(hours/2.5)} hours`, // Riding is about 2.5x faster
                        distance: Math.round(miles)
                    };
                }
                return {
                    walking: `${days} day${days > 1 ? 's' : ''}`,
                    riding: `${Math.ceil(hours/2.5)} hours`,
                    distance: Math.round(miles)
                };
            } else if (hours < 1) {
                const minutes = Math.round(hours * 60);
                return {
                    walking: `${minutes} minutes`,
                    riding: `${Math.round(minutes/2.5)} minutes`,
                    distance: Math.round(miles * 10) / 10
                };
            } else {
                return {
                    walking: `${Math.round(hours)} hour${Math.round(hours) > 1 ? 's' : ''}`,
                    riding: `${Math.ceil(hours/2.5)} hours`,
                    distance: Math.round(miles)
                };
            }
        }
        
        // Distance calculator functionality
        document.getElementById('select-from').addEventListener('click', function() {
            selectingFrom = true;
            selectingTo = false;
            this.classList.add('active');
            document.getElementById('select-to').classList.remove('active');
            map.getContainer().style.cursor = 'crosshair';
        });
        
        document.getElementById('select-to').addEventListener('click', function() {
            selectingTo = true;
            selectingFrom = false;
            this.classList.add('active');
            document.getElementById('select-from').classList.remove('active');
            map.getContainer().style.cursor = 'crosshair';
        });
        
        document.getElementById('clear-selection').addEventListener('click', function() {
            selectingFrom = false;
            selectingTo = false;
            fromPoint = null;
            toPoint = null;
            
            if (fromMarker) map.removeLayer(fromMarker);
            if (toMarker) map.removeLayer(toMarker);
            if (pathLine) map.removeLayer(pathLine);
            
            fromMarker = null;
            toMarker = null;
            pathLine = null;
            
            document.getElementById('point-from').innerHTML = 'From: <em>Click "Select Start"</em>';
            document.getElementById('point-to').innerHTML = 'To: <em>Click "Select End"</em>';
            document.getElementById('distance-result').style.display = 'none';
            document.getElementById('select-from').classList.remove('active');
            document.getElementById('select-to').classList.remove('active');
            map.getContainer().style.cursor = '';
        });
        
        // Handle map clicks for distance calculation
        map.on('click', function(e) {
            if (selectingFrom) {
                if (fromMarker) map.removeLayer(fromMarker);
                fromPoint = e.latlng;
                fromMarker = L.marker(e.latlng, {
                    icon: createEmojiIcon('üìç', 30)
                }).addTo(map);
                document.getElementById('point-from').innerHTML = `From: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
                selectingFrom = false;
                document.getElementById('select-from').classList.remove('active');
                map.getContainer().style.cursor = '';
                
                if (fromPoint && toPoint) updateDistance();
            } else if (selectingTo) {
                if (toMarker) map.removeLayer(toMarker);
                toPoint = e.latlng;
                toMarker = L.marker(e.latlng, {
                    icon: createEmojiIcon('üéØ', 30)
                }).addTo(map);
                document.getElementById('point-to').innerHTML = `To: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
                selectingTo = false;
                document.getElementById('select-to').classList.remove('active');
                map.getContainer().style.cursor = '';
                
                if (fromPoint && toPoint) updateDistance();
            }
        });
        
        function updateDistance() {
            if (pathLine) map.removeLayer(pathLine);
            
            pathLine = L.polyline([fromPoint, toPoint], {
                color: '#ff6b6b',
                weight: 3,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);
            
            const time = calculateWalkingTime(
                fromPoint.lat, fromPoint.lng,
                toPoint.lat, toPoint.lng
            );
            
            document.getElementById('distance-result').innerHTML = `
                <strong>Distance:</strong> ~${time.distance} miles<br>
                <strong>üö∂ Walking Time:</strong> ${time.walking}<br>
                <strong>üêé Riding Time:</strong> ${time.riding}<br>
                <em style="font-size: 11px;">Medieval travel estimates</em>
            `;
            document.getElementById('distance-result').style.display = 'block';
        }
        
        // Add all layers to map
        forestLayer.addTo(map);
        covenantLayer.addTo(map);
        birminghamBuildingsLayer.addTo(map);
        havensLayer.addTo(map);
        religiousLayer.addTo(map);
        faeLayer.addTo(map);
        infrastructureLayer.addTo(map);
        poisLayer.addTo(map);
        forestPoisLayer.addTo(map);
        settlementsLayer.addTo(map);
        regionalLayer.addTo(map);
        majorCitiesLayer.addTo(map);
        
        // Store all overlay layers
        const allOverlays = {
            "Forest of Arden": forestLayer,
            "Covenant Boundary": covenantLayer,
            "Birmingham Buildings": birminghamBuildingsLayer,
            "Character Havens": havensLayer,
            "Religious Sites": religiousLayer,
            "Fae Sites & Camps": faeLayer,
            "Infrastructure": infrastructureLayer,
            "Points of Interest": poisLayer,
            "Forest Locations": forestPoisLayer,
            "Local Settlements": settlementsLayer,
            "Regional Towns": regionalLayer,
            "Major Cities": majorCitiesLayer
        };
        
        // Layer control
        const layerControl = L.control.layers(null, allOverlays, {collapsed: false});
        layerControl.addTo(map);
        
        // Select/Deselect All functionality
        document.getElementById('select-all').addEventListener('click', function() {
            for (let name in allOverlays) {
                map.addLayer(allOverlays[name]);
            }
        });
        
        document.getElementById('deselect-all').addEventListener('click', function() {
            for (let name in allOverlays) {
                map.removeLayer(allOverlays[name]);
            }
        });
        
        // Legend
        const legend = L.control({position: 'bottomright'});
        
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h3>Birmingham 1410</h3>
                <div class="legend-item">
                    <span class="legend-symbol">üíú</span>
                    <span>Covenant Boundary</span>
                </div>
                <div class="legend-item">
                    <span class="legend-symbol">üèõÔ∏è</span>
                    <span>Birmingham Buildings</span>
                </div>
                <div class="legend-item">
                    <span class="legend-symbol">üõ°Ô∏è</span>
                    <span>Character Havens</span>
                </div>
                <div class="legend-item">
                    <span class="legend-symbol">‚õ™</span>
                    <span>Religious Sites</span>
                </div>
                <div class="legend-item">
                    <span class="legend-symbol">üßö</span>
                    <span>Fae Sites</span>
                </div>
                <div class="legend-item">
                    <span class="legend-symbol">‚öôÔ∏è</span>
                    <span>Infrastructure</span>
                </div>
                <div class="legend-item">
                    <span class="legend-symbol">üìç</span>
                    <span>Points of Interest</span>
                </div>
                <div class="legend-item">
                    <span class="legend-symbol">üå≤</span>
                    <span>Forest Locations</span>
                </div>
                <div class="legend-item">
                    <span class="legend-symbol">üèòÔ∏è</span>
                    <span>Settlements</span>
                </div>
                <div class="legend-item">
                    <span class="legend-symbol">üè∞</span>
                    <span>Regional Towns</span>
                </div>
                <div class="legend-item">
                    <span class="legend-symbol">üèôÔ∏è</span>
                    <span>Major Cities</span>
                </div>
            `;
            return div;
        };
        
        legend.addTo(map);
        
        // Default view
        const birminghamBounds = L.latLngBounds([
            [52.42, -2.0],
            [52.55, -1.8]
        ]);
        map.fitBounds(birminghamBounds);
    </script>
</body>
</html>