<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birmingham 1410 - Chronicle Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            display: flex;
        }
        
        #sidebar {
            width: 300px;
            height: 100vh;
            background: rgba(20, 20, 20, 0.95);
            overflow-y: auto;
            border-right: 2px solid #444;
            z-index: 1000;
        }
        
        #map {
            flex: 1;
            height: 100vh;
        }
        
        .search-container {
            padding: 15px;
            background: #2a2a2a;
            border-bottom: 2px solid #444;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .search-container input {
            width: 100%;
            padding: 8px;
            background: #333;
            color: #fff;
            border: 1px solid #666;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-container input::placeholder {
            color: #999;
        }
        
        .category-list {
            padding: 10px;
        }
        
        .category {
            margin-bottom: 5px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #2a2a2a;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            user-select: none;
            background: #333;
            border-radius: 3px;
        }
        
        .category-header:hover {
            background: #3a3a3a;
        }
        
        .category-header input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .category-name {
            flex: 1;
            color: #e0e0e0;
            font-weight: bold;
            font-size: 13px;
        }
        
        .category-arrow {
            color: #999;
            transition: transform 0.2s;
        }
        
        .category.expanded .category-arrow {
            transform: rotate(90deg);
        }
        
        .category-items {
            display: none;
            padding: 5px 5px 5px 25px;
            background: #252525;
        }
        
        .category.expanded .category-items {
            display: block;
        }
        
        .item {
            display: flex;
            align-items: center;
            padding: 4px;
            color: #ccc;
            font-size: 12px;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .item:hover {
            background: #333;
        }
        
        .item input[type="checkbox"] {
            margin-right: 6px;
        }
        
        .item-name {
            flex: 1;
        }
        
        .item.hidden {
            display: none;
        }
        
        .category.hidden {
            display: none;
        }
        
        .controls {
            padding: 10px;
            border-bottom: 2px solid #444;
            display: flex;
            gap: 10px;
        }
        
        .controls button {
            flex: 1;
            padding: 6px;
            background: #444;
            color: #fff;
            border: 1px solid #666;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .controls button:hover {
            background: #555;
        }
        
        .basemap-control {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(20, 20, 20, 0.95);
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #444;
        }
        
        .basemap-control select {
            padding: 5px;
            background: #333;
            color: #fff;
            border: 1px solid #666;
            border-radius: 3px;
        }
        
        .distance-calculator {
            position: absolute;
            bottom: 20px;
            right: 10px;
            z-index: 1000;
            background: rgba(20, 20, 20, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
            color: #e0e0e0;
            width: 250px;
        }
        
        .distance-calculator h4 {
            margin: 0 0 10px 0;
            color: #f0f0f0;
            border-bottom: 1px solid #666;
            padding-bottom: 5px;
            font-size: 13px;
        }
        
        .distance-calculator button {
            width: 100%;
            margin: 5px 0;
            padding: 6px;
            background: #444;
            color: #fff;
            border: 1px solid #666;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .distance-calculator button:hover {
            background: #555;
        }
        
        .distance-calculator button.active {
            background: #4169e1;
        }
        
        .distance-result {
            margin-top: 10px;
            padding: 8px;
            background: #333;
            border-radius: 3px;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .distance-points {
            margin: 5px 0;
            padding: 5px;
            background: #2a2a2a;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .emoji-marker {
            font-size: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            background: rgba(255, 255, 255, 0.35);
            border: 2px solid rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }
        
        .marker-label {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.8);
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            margin-left: 35px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .emoji-with-label {
            display: flex;
            align-items: center;
        }
        
        .controls {
            padding: 10px;
            border-bottom: 2px solid #444;
        }
        
        .controls button {
            padding: 6px;
            background: #444;
            color: #fff;
            border: 1px solid #666;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
        }
        
        .controls button:hover {
            background: #555;
        }
        
        .custom-popup {
            font-size: 13px;
            line-height: 1.4;
            max-width: 280px;
        }
        
        .custom-popup h4 {
            margin: 0 0 6px 0;
            color: #333;
            border-bottom: 2px solid #666;
            padding-bottom: 3px;
        }
        
        .popup-detail {
            margin: 3px 0;
            color: #555;
        }
        
        .popup-souls {
            font-weight: bold;
            color: #8b0000;
        }
        
        .popup-travel {
            color: #666;
            margin-top: 4px;
        }
        
        .popup-walking {
            font-style: italic;
        }
        
        .popup-riding {
            font-style: italic;
            color: #4169e1;
        }
        
        .leaflet-container {
            background: #1a1a1a;
        }
        
        .covenant-boundary {
            stroke: #9400d3;
            stroke-width: 3;
            stroke-opacity: 0.7;
            fill: #9400d3;
            fill-opacity: 0.15;
            stroke-dasharray: 10, 5;
        }
        
        .forest-arden {
            stroke: #228b22;
            stroke-width: 2;
            stroke-opacity: 0.7;
            fill: #228b22;
            fill-opacity: 0.1;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search locations...">
        </div>
        <div class="controls">
            <button id="select-all">Select All</button>
            <button id="deselect-all">Clear All</button>
            <button id="toggle-labels">Show Labels</button>
        </div>
        <div id="category-list" class="category-list"></div>
    </div>
    
    <div id="map"></div>
    
    <div class="basemap-control">
        <select id="basemap-select">
            <option value="satellite">Satellite</option>
            <option value="terrain">Terrain</option>
            <option value="street">Street</option>
        </select>
    </div>
    
    <div class="distance-calculator">
        <h4>‚è±Ô∏è Travel Time Calculator</h4>
        <div class="distance-points">
            <div id="point-from">From: <em>Click "Select Start"</em></div>
            <div id="point-to">To: <em>Click "Select End"</em></div>
        </div>
        <button id="select-from">üìç Select Start Point</button>
        <button id="select-to">üéØ Select End Point</button>
        <button id="clear-selection">‚ùå Clear</button>
        <div id="distance-result" class="distance-result" style="display: none;"></div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map', {
            center: [52.4862, -1.8904],
            zoom: 11,
            minZoom: 6,
            maxZoom: 18
        });
        
        // Travel time calculator state
        let selectingFrom = false;
        let selectingTo = false;
        let fromPoint = null;
        let toPoint = null;
        let fromMarker = null;
        let toMarker = null;
        let pathLine = null;
        
        // Store all locations and categories
        const categories = {};
        const allMarkers = [];
        let showLabels = false;
        
        // Define base layers
        const baseLayers = {
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '&copy; Esri'
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenTopoMap'
            }),
            street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            })
        };
        
        // Add default layer
        baseLayers.satellite.addTo(map);
        
        // Add street names overlay
        const labelLayer = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}{r}.png', {
            attribution: 'Map labels by Stamen Design',
            subdomains: 'abcd',
            opacity: 0.7
        }).addTo(map);
        
        // Basemap selector
        document.getElementById('basemap-select').addEventListener('change', function(e) {
            for (let key in baseLayers) {
                map.removeLayer(baseLayers[key]);
            }
            baseLayers[e.target.value].addTo(map);
            labelLayer.bringToFront();
        });
        
        // Calculate east shift for Birmingham locations
        const eastShift = 0.004;
        
        // Define custom emoji icons
        const createEmojiIcon = (emoji, label = '', size = 30) => {
            const html = showLabels && label ? 
                `<div class="emoji-with-label">
                    <div class="emoji-marker">${emoji}</div>
                    <div class="marker-label">${label}</div>
                </div>` :
                `<div class="emoji-marker">${emoji}</div>`;
            
            const iconSize = showLabels && label ? [120, 30] : [size, size];
            const iconAnchor = showLabels && label ? [15, 15] : [size/2, size/2];
            
            return L.divIcon({
                html: html,
                iconSize: iconSize,
                iconAnchor: iconAnchor,
                popupAnchor: [0, -size/2],
                className: 'emoji-icon'
            });
        };
        
        const icons = {
            church: createEmojiIcon('‚õ™'),
            building: createEmojiIcon('üèõÔ∏è'),
            manor: createEmojiIcon('üè∞'),
            inn: createEmojiIcon('üç∫'),
            forge: createEmojiIcon('‚öíÔ∏è'),
            settlement: createEmojiIcon('üèòÔ∏è'),
            town: createEmojiIcon('üè∞'),
            city: createEmojiIcon('üèôÔ∏è', 32),
            haven: createEmojiIcon('üõ°Ô∏è'),
            fae: createEmojiIcon('üßö'),
            infrastructure: createEmojiIcon('‚öôÔ∏è'),
            poi: createEmojiIcon('üìç'),
            forest: createEmojiIcon('üå≤')
        };
        
        // Initialize categories
        function initCategory(name, emoji) {
            if (!categories[name]) {
                categories[name] = {
                    name: name,
                    emoji: emoji,
                    items: [],
                    layer: L.layerGroup().addTo(map)
                };
            }
            return categories[name];
        }
        
        // Add location to category
        function addLocation(category, location, iconEmoji) {
            const icon = createEmojiIcon(iconEmoji);
            const marker = L.marker([location.lat, location.lng], {icon: icon})
                .bindPopup(`<div class="custom-popup"><h4>${location.name}</h4>${location.detail ? `<div class="popup-detail">${location.detail}</div>` : ''}${location.souls ? `<div class="popup-souls">Population: ${location.souls} souls</div>` : ''}${location.time ? `<div class="popup-distance">${location.time}</div>` : ''}</div>`);
            
            marker.addTo(category.layer);
            
            const item = {
                name: location.name,
                marker: marker,
                location: location,
                emoji: iconEmoji,
                visible: true
            };
            
            category.items.push(item);
            allMarkers.push({...item, category: category.name});
            
            return marker;
        }
        
        // Function to update all marker icons based on label state
        function updateMarkerLabels() {
            Object.values(categories).forEach(category => {
                category.items.forEach(item => {
                    if (item.marker && item.emoji) {
                        const newIcon = createEmojiIcon(item.emoji, item.name);
                        item.marker.setIcon(newIcon);
                    }
                });
            });
        }
        
        // Setup Covenant
        const covenantPoints = [
            {lat: 52.499, lng: -1.884},
            {lat: 52.471, lng: -1.877},
            {lat: 52.445, lng: -1.885},
            {lat: 52.477, lng: -1.935},
            {lat: 52.507, lng: -1.924},
            {lat: 52.4510, lng: -1.9384},
            {lat: 52.525, lng: -1.880}
        ];
        
        const covenantRadius = 2011.68;
        let boundaryPoints = [];
        covenantPoints.forEach(center => {
            for (let angle = 0; angle < 360; angle += 10) {
                const lat = center.lat + (covenantRadius / 111320) * Math.cos(angle * Math.PI / 180);
                const lng = center.lng + (covenantRadius / (111320 * Math.cos(center.lat * Math.PI / 180))) * Math.sin(angle * Math.PI / 180);
                boundaryPoints.push([lat, lng]);
            }
        });
        
        function convexHull(points) {
            points.sort((a, b) => a[0] - b[0] || a[1] - b[1]);
            const lower = [];
            for (let i = 0; i < points.length; i++) {
                while (lower.length >= 2 && cross(lower[lower.length - 2], lower[lower.length - 1], points[i]) <= 0) {
                    lower.pop();
                }
                lower.push(points[i]);
            }
            const upper = [];
            for (let i = points.length - 1; i >= 0; i--) {
                while (upper.length >= 2 && cross(upper[upper.length - 2], upper[upper.length - 1], points[i]) <= 0) {
                    upper.pop();
                }
                upper.push(points[i]);
            }
            upper.pop();
            lower.pop();
            return lower.concat(upper);
            
            function cross(O, A, B) {
                return (A[0] - O[0]) * (B[1] - O[1]) - (A[1] - O[1]) * (B[0] - O[0]);
            }
        }
        
        const specialLayers = initCategory('Special Layers', 'üó∫Ô∏è');
        const covenantBoundary = convexHull(boundaryPoints);
        const covenantPolygon = L.polygon(covenantBoundary, {className: 'covenant-boundary'})
            .bindPopup('<div class="custom-popup"><h4>The Covenant Boundary</h4><div class="popup-detail">Supernatural protection extends throughout this area</div></div>')
            .addTo(specialLayers.layer);
        specialLayers.items.push({name: 'Covenant Boundary', marker: covenantPolygon, visible: true});
        
        const ardenBounds = [[52.65, -2.65], [52.65, -1.48], [51.90, -1.48], [51.90, -2.65]];
        const forestPolygon = L.rectangle(ardenBounds, {
            color: '#228b22', weight: 2, opacity: 0.6, fillColor: '#228b22', fillOpacity: 0.1, className: 'forest-arden'
        }).bindPopup('<div class="custom-popup"><h4>Forest of Arden</h4><div class="popup-detail">Ancient woodland spanning the heart of England</div></div>')
          .addTo(specialLayers.layer);
        specialLayers.items.push({name: 'Forest of Arden', marker: forestPolygon, visible: true});
        
        // Birmingham Buildings
        const birminghamCat = initCategory('Birmingham Buildings', 'üèõÔ∏è');
        [
            {name: "St. Martin's Church", lat: 52.4770, lng: -1.8976 + eastShift, detail: "Parish church", emoji: '‚õ™'},
            {name: "St. Thomas's Priory", lat: 52.482, lng: -1.895, detail: "House of Augustinian canons", emoji: '‚õ™'},
            {name: "Bull Ring Market", lat: 52.4768, lng: -1.8974 + eastShift, detail: "Triangular market space", emoji: 'üèõÔ∏è'},
            {name: "De Birmingham Manor", lat: 52.479, lng: -1.900 + eastShift, detail: "Moated manor complex", emoji: 'üè∞'},
            {name: "Guild of the Holy Cross Hall", lat: 52.4785, lng: -1.8945 + eastShift, detail: "Guild meeting hall", emoji: 'üèõÔ∏è'},
            {name: "Market Cross", lat: 52.4768, lng: -1.8975 + eastShift, detail: "Town center", emoji: 'üèõÔ∏è'},
            {name: "Stocks & Pillory", lat: 52.4767, lng: -1.8973 + eastShift, detail: "Justice and punishment", emoji: 'üèõÔ∏è'},
            {name: "The Shambles", lat: 52.4775, lng: -1.8970 + eastShift, detail: "Butchers' quarter", emoji: 'üèõÔ∏è'},
            {name: "The Old Crown", lat: 52.476, lng: -1.892 + eastShift, detail: "Tavern in Deritend", emoji: 'üç∫'},
            {name: "Silver Swan Inn", lat: 52.478, lng: -1.894 + eastShift, detail: "Moor Street inn", emoji: 'üç∫'},
            {name: "Master Woolmonger's House", lat: 52.478, lng: -1.895 + eastShift, detail: "Wealthy merchant residence", emoji: 'üèõÔ∏è'},
            {name: "Master John Smith's Forge", lat: 52.475, lng: -1.895 + eastShift, detail: "Digbeth smithy", emoji: '‚öíÔ∏è'},
            {name: "Master Wilhelm's Silver Workshop", lat: 52.476, lng: -1.896 + eastShift, detail: "Digbeth workshop", emoji: '‚öíÔ∏è'},
            {name: "Thomas Ironwright's Smithy", lat: 52.475, lng: -1.897 + eastShift, detail: "New Street area", emoji: '‚öíÔ∏è'}
        ].forEach(loc => addLocation(birminghamCat, loc, loc.emoji));
        
        // Character Havens
        const havensCat = initCategory('Character Havens', 'üõ°Ô∏è');
        [
            {name: "Gunnar's Barrow", lat: 52.520, lng: -1.880, detail: "Ancient burial mound, 3 miles north", time: "20 min to town"},
            {name: "Elizabeth's Tower", lat: 52.4815, lng: -1.9015 + eastShift, detail: "Within De Birmingham Manor", time: "5 min to Bull Ring"},
            {name: "Marcus's Laboratory", lat: 52.478, lng: -1.895 + eastShift, detail: "Secret beneath Woolmonger's", time: "3 min to Bull Ring"},
            {name: "Lucian's Crypt", lat: 52.4770, lng: -1.8976 + eastShift, detail: "Beneath St. Martin's Church", time: "In town center"},
            {name: "Morganna's Roman Villa", lat: 52.450, lng: -1.900, detail: "Ancient ruins, 2 miles south", time: "40 min walk"}
        ].forEach(loc => addLocation(havensCat, loc, 'üõ°Ô∏è'));
        
        // Fae Sites
        const faeCat = initCategory('Fae Sites & Camps', 'üßö');
        [
            {name: "The Standing Stones", lat: 52.477, lng: -1.875, detail: "1 mile east, neutral ground"},
            {name: "The Hollow Oak", lat: 52.505, lng: -1.875, detail: "Ancient oak, wedding venue"},
            {name: "The Heart Oak", lat: 52.565, lng: -1.870, detail: "Deep Arden, Old Man of the Wood"},
            {name: "Northern Forest Camp", lat: 52.495, lng: -1.895, detail: "Fae refugee camp"},
            {name: "Eastern Heath Camp", lat: 52.475, lng: -1.870, detail: "Fae refugee camp"},
            {name: "Southern Valley Camp", lat: 52.455, lng: -1.900, detail: "Fae refugee camp"},
            {name: "Western Woods Camp", lat: 52.470, lng: -1.920, detail: "Fae refugee camp"},
            {name: "River Bend Camp", lat: 52.465, lng: -1.885, detail: "Fae refugee camp"}
        ].forEach(loc => addLocation(faeCat, loc, 'üßö'));
        
        // Forest Locations
        const forestCat = initCategory('Forest Locations', 'üå≤');
        [
            {name: "Moonlit Grove", lat: 52.535, lng: -1.920, detail: "Sacred clearing, fae dancing"},
            {name: "Hunter's Rest", lat: 52.510, lng: -1.960, detail: "Ancient waystation"},
            {name: "Whispering Stones", lat: 52.545, lng: -1.850, detail: "Pre-Roman stone circle"},
            {name: "Dead Man's Clearing", lat: 52.490, lng: -1.940, detail: "Ancient battle site"},
            {name: "Silver Spring", lat: 52.525, lng: -1.890, detail: "Pure water, healing"},
            {name: "The Watcher's Tree", lat: 52.555, lng: -1.880, detail: "Giant oak, ravens"},
            {name: "Mushroom Dell", lat: 52.500, lng: -1.910, detail: "Fairy rings"},
            {name: "Wolf's Hollow", lat: 52.530, lng: -1.865, detail: "Werewolf grounds"},
            {name: "Hermit's Cave", lat: 52.515, lng: -1.935, detail: "Strange writings"},
            {name: "The Crossroads", lat: 52.505, lng: -1.885, detail: "Three paths meet"},
            {name: "Hanging Tree", lat: 52.495, lng: -1.870, detail: "Justice tree"},
            {name: "Druid's Pool", lat: 52.540, lng: -1.905, detail: "Dark water"},
            {name: "Broken Tower", lat: 52.520, lng: -1.845, detail: "Ruined watchtower"},
            {name: "The Green Chapel", lat: 52.485, lng: -1.855, detail: "Nature shrine"},
            {name: "Starfall Meadow", lat: 52.550, lng: -1.915, detail: "Meteor iron"}
        ].forEach(loc => addLocation(forestCat, loc, 'üå≤'));
        
        // Infrastructure
        const infraCat = initCategory('Infrastructure', '‚öôÔ∏è');
        [
            {name: "Town Mill", lat: 52.473, lng: -1.893 + eastShift, detail: "On River Rea"},
            {name: "Common Grazing", lat: 52.465, lng: -1.900, detail: "South of town"},
            {name: "Quarry", lat: 52.475, lng: -1.920, detail: "Sandstone source"},
            {name: "Archery Butts", lat: 52.480, lng: -1.870, detail: "Training ground"},
            {name: "Gallows Hill", lat: 52.490, lng: -1.900, detail: "Execution site"}
        ].forEach(loc => addLocation(infraCat, loc, '‚öôÔ∏è'));
        
        // Points of Interest
        const poiCat = initCategory('Points of Interest', 'üìç');
        [
            {name: "Aston Mill Roman Ruins", lat: 52.499, lng: -1.884, detail: "Roman fortification"},
            {name: "Bordesley Abbey Ruins", lat: 52.471, lng: -1.877, detail: "Roman temple"},
            {name: "Moseley Bog Roman Fort", lat: 52.445, lng: -1.885, detail: "Roman outpost"},
            {name: "Harborne Hill Roman Villa", lat: 52.477, lng: -1.935, detail: "Roman villa"},
            {name: "Handsworth Grove Shrine", lat: 52.507, lng: -1.924, detail: "Roman grove"},
            {name: "Metchley Fort Ruins", lat: 52.4510, lng: -1.9384, detail: "Main Roman fort"},
            {name: "Old Saxon Meeting Stone", lat: 52.485, lng: -1.895, detail: "Pre-conquest"},
            {name: "Small Norman Tower", lat: 52.492, lng: -1.878, detail: "Ruined tower"},
            {name: "Holy Well of St. Chad", lat: 52.495, lng: -1.865, detail: "Healing spring"},
            {name: "Old Stone Bridge", lat: 52.473, lng: -1.885, detail: "Roman foundations"},
            {name: "Leper Hospital", lat: 52.462, lng: -1.895, detail: "St. Lazarus"},
            {name: "Iron Bloomery", lat: 52.498, lng: -1.888, detail: "Aston ironworks"},
            {name: "Tanners' Quarter", lat: 52.472, lng: -1.892 + eastShift, detail: "Leather working"},
            {name: "Mill Pool", lat: 52.477, lng: -1.906, detail: "Dammed river"},
            {name: "Charcoal Burners' Camp", lat: 52.455, lng: -1.925, detail: "Forest edge"},
            {name: "Roman Road Junction", lat: 52.468, lng: -1.888, detail: "Ryknild & Watling"},
            {name: "Plague Pit", lat: 52.463, lng: -1.912, detail: "1350s burial"},
            {name: "Hermit's Cell", lat: 52.488, lng: -1.865, detail: "Anchorite dwelling"},
            {name: "Get of Fenris Den", lat: 52.525, lng: -1.875, detail: "Werewolf territory"},
            {name: "Northwest Logging Camp", lat: 52.515, lng: -1.920, detail: "Lichfield road"},
            {name: "Northeast Logging Camp", lat: 52.510, lng: -1.850, detail: "Tamworth road"},
            {name: "East Logging Camp", lat: 52.485, lng: -1.845, detail: "Coventry road"}
        ].forEach(loc => addLocation(poiCat, loc, 'üìç'));
        
        // Settlements
        const settlementsCat = initCategory('Local Settlements', 'üèòÔ∏è');
        [
            {name: "Aston", lat: 52.506, lng: -1.890, souls: "600-800", time: "30 min walk"},
            {name: "Erdington", lat: 52.520, lng: -1.840, souls: "300-400", time: "1 hour walk"},
            {name: "Yardley", lat: 52.475, lng: -1.810, souls: "400-500", time: "1.5 hours walk"},
            {name: "Handsworth", lat: 52.507, lng: -1.924, souls: "250-350", time: "45 min walk"},
            {name: "Edgbaston", lat: 52.465, lng: -1.925, souls: "200-300", time: "45 min walk"},
            {name: "Witton", lat: 52.515, lng: -1.885, souls: "150-200", time: "45 min walk"},
            {name: "Selly Oak", lat: 52.438, lng: -1.936, souls: "100-150", time: "1 hour walk"},
            {name: "King's Norton", lat: 52.416, lng: -1.900, souls: "300-400", time: "2 hours walk"},
            {name: "Northfield", lat: 52.411, lng: -1.964, souls: "250-300", time: "2.5 hours walk"},
            {name: "Sutton Coldfield", lat: 52.5704, lng: -1.8240, souls: "500-700", time: "3 hours walk"},
            {name: "Solihull", lat: 52.4143, lng: -1.7809, souls: "400-500", time: "3 hours walk"}
        ].forEach(loc => addLocation(settlementsCat, loc, 'üèòÔ∏è'));
        
        // Regional Towns
        const regionalCat = initCategory('Regional Towns', 'üè∞');
        [
            {name: "Coventry", lat: 52.4081, lng: -1.5106, souls: "6,000-8,000", detail: "Major trade center, within Forest of Arden", walking: "1 day", riding: "4-5 hours"},
            {name: "Lichfield", lat: 52.6835, lng: -1.8266, souls: "2,000", detail: "Cathedral city", walking: "1 day", riding: "3-4 hours"},
            {name: "Warwick", lat: 52.2832, lng: -1.5849, souls: "2,000-2,500", detail: "County town, within Forest of Arden", walking: "1 day", riding: "4-5 hours"},
            {name: "Tamworth", lat: 52.6340, lng: -1.6959, souls: "1,500", detail: "Former Mercian capital", walking: "5-6 hours", riding: "2-3 hours"},
            {name: "Worcester", lat: 52.1894, lng: -2.2200, souls: "3,000", detail: "Cathedral city, River Severn port", walking: "1.5-2 days", riding: "6-8 hours"},
            {name: "Leicester", lat: 52.6369, lng: -1.1398, souls: "3,000", detail: "Major wool market", walking: "1.5-2 days", riding: "6-8 hours"},
            {name: "Nottingham", lat: 52.9548, lng: -1.1581, souls: "3,000", detail: "Castle and market town", walking: "2 days", riding: "8-10 hours"},
            {name: "Shrewsbury", lat: 52.7073, lng: -2.7527, souls: "3,000", detail: "Welsh border fortress", walking: "2 days", riding: "8-10 hours"},
            {name: "Hereford", lat: 52.0565, lng: -2.7160, souls: "2,000", detail: "Cathedral city, Welsh marches", walking: "2 days", riding: "1 day"},
            {name: "Gloucester", lat: 51.8642, lng: -2.2382, souls: "2,500", detail: "Abbey town, River Severn crossing", walking: "2 days", riding: "8-10 hours"},
            {name: "Derby", lat: 52.9225, lng: -1.4746, souls: "1,500", detail: "Market town", walking: "1.5 days", riding: "6-7 hours"},
            {name: "Stafford", lat: 52.8066, lng: -2.1159, souls: "1,200", detail: "County town", walking: "1 day", riding: "4-5 hours"}
        ].forEach(loc => {
            const marker = L.marker([loc.lat, loc.lng], {icon: icons.town})
                .bindPopup(`<div class="custom-popup">
                    <h4>${loc.name}</h4>
                    <div class="popup-souls">Population: ${loc.souls} souls</div>
                    <div class="popup-travel">
                        <div class="popup-walking">Walking: ${loc.walking}</div>
                        <div class="popup-riding">Riding: ${loc.riding}</div>
                    </div>
                    <div class="popup-detail">${loc.detail}</div>
                </div>`);
            
            marker.addTo(regionalCat.layer);
            regionalCat.items.push({
                name: loc.name,
                marker: marker,
                location: loc,
                visible: true
            });
        });
        
        // Major Cities
        const citiesCat = initCategory('Major Cities', 'üèôÔ∏è');
        [
            {name: "London", lat: 51.5074, lng: -0.1278, souls: "35,000-40,000", detail: "Capital of England, Mithras's domain", walking: "4-5 days", riding: "2 days"},
            {name: "York", lat: 53.9591, lng: -1.0815, souls: "8,000-10,000", detail: "Second city of England, Archbishop's seat", walking: "4-5 days", riding: "2 days"},
            {name: "Bristol", lat: 51.4545, lng: -2.5879, souls: "8,000-10,000", detail: "Major western port, Atlantic trade", walking: "2-3 days", riding: "1 day"},
            {name: "Norwich", lat: 52.6309, lng: 1.2974, souls: "7,000-8,000", detail: "East Anglia's capital, wool trade center", walking: "5-6 days", riding: "2-3 days"},
            {name: "Oxford", lat: 51.7520, lng: -1.2577, souls: "4,000", detail: "University town, center of learning", walking: "2 days", riding: "1 day"},
            {name: "Chester", lat: 53.1930, lng: -2.8930, souls: "3,000", detail: "Border fortress, Irish Sea port", walking: "2-3 days", riding: "1 day"},
            {name: "Lincoln", lat: 53.2307, lng: -0.5406, souls: "4,000", detail: "Cathedral city, wool staple", walking: "3 days", riding: "1-1.5 days"},
            {name: "Canterbury", lat: 51.2802, lng: 1.0789, souls: "3,000", detail: "Pilgrimage center, Archbishop's seat", walking: "5-6 days", riding: "2-3 days"},
            {name: "Winchester", lat: 51.0632, lng: -1.3080, souls: "2,000", detail: "Former capital, cathedral city", walking: "4 days", riding: "2 days"},
            {name: "Salisbury", lat: 51.0693, lng: -1.7957, souls: "3,500", detail: "Cathedral city, cloth market", walking: "3-4 days", riding: "1.5-2 days"},
            {name: "Exeter", lat: 50.7184, lng: -3.5339, souls: "3,000", detail: "Devon capital, tin trade", walking: "5-6 days", riding: "2-3 days"},
            {name: "Newcastle", lat: 54.9783, lng: -1.6178, souls: "5,000-6,000", detail: "Northern stronghold, coal trade", walking: "6-7 days", riding: "3 days"}
        ].forEach(loc => {
            const marker = L.marker([loc.lat, loc.lng], {icon: icons.city})
                .bindPopup(`<div class="custom-popup">
                    <h4>${loc.name}</h4>
                    <div class="popup-souls">Population: ${loc.souls} souls</div>
                    <div class="popup-travel">
                        <div class="popup-walking">Walking: ${loc.walking}</div>
                        <div class="popup-riding">Riding: ${loc.riding}</div>
                    </div>
                    <div class="popup-detail">${loc.detail}</div>
                </div>`);
            
            marker.addTo(citiesCat.layer);
            citiesCat.items.push({
                name: loc.name,
                marker: marker,
                location: loc,
                visible: true
            });
        });
        
        // Build UI
        function buildUI() {
            const categoryList = document.getElementById('category-list');
            categoryList.innerHTML = '';
            
            Object.values(categories).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.dataset.category = category.name;
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'category-header';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const checked = this.checked;
                    category.items.forEach(item => {
                        if (checked && item.visible) {
                            category.layer.addLayer(item.marker);
                        } else {
                            category.layer.removeLayer(item.marker);
                        }
                    });
                    categoryDiv.querySelectorAll('.item input[type="checkbox"]').forEach(cb => {
                        cb.checked = checked;
                    });
                });
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'category-name';
                nameSpan.textContent = `${category.emoji} ${category.name}`;
                
                const arrow = document.createElement('span');
                arrow.className = 'category-arrow';
                arrow.textContent = '‚ñ∂';
                
                headerDiv.appendChild(checkbox);
                headerDiv.appendChild(nameSpan);
                headerDiv.appendChild(arrow);
                
                headerDiv.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        categoryDiv.classList.toggle('expanded');
                    }
                });
                
                const itemsDiv = document.createElement('div');
                itemsDiv.className = 'category-items';
                
                category.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    
                    const itemCheckbox = document.createElement('input');
                    itemCheckbox.type = 'checkbox';
                    itemCheckbox.checked = true;
                    itemCheckbox.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (this.checked) {
                            category.layer.addLayer(item.marker);
                        } else {
                            category.layer.removeLayer(item.marker);
                        }
                    });
                    
                    const itemName = document.createElement('span');
                    itemName.className = 'item-name';
                    itemName.textContent = item.name;
                    
                    itemDiv.appendChild(itemCheckbox);
                    itemDiv.appendChild(itemName);
                    
                    itemDiv.addEventListener('click', function() {
                        if (item.location) {
                            map.setView([item.location.lat, item.location.lng], 15);
                            item.marker.openPopup();
                        }
                    });
                    
                    itemsDiv.appendChild(itemDiv);
                });
                
                categoryDiv.appendChild(headerDiv);
                categoryDiv.appendChild(itemsDiv);
                categoryList.appendChild(categoryDiv);
            });
        }
        
        buildUI();
        
        // Search functionality
        document.getElementById('search-input').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            document.querySelectorAll('.category').forEach(categoryDiv => {
                const categoryName = categoryDiv.dataset.category;
                const category = categories[categoryName];
                let hasVisibleItems = false;
                
                categoryDiv.querySelectorAll('.item').forEach((itemDiv, index) => {
                    const item = category.items[index];
                    if (item.name.toLowerCase().includes(searchTerm)) {
                        itemDiv.classList.remove('hidden');
                        hasVisibleItems = true;
                    } else {
                        itemDiv.classList.add('hidden');
                    }
                });
                
                if (hasVisibleItems || searchTerm === '') {
                    categoryDiv.classList.remove('hidden');
                } else {
                    categoryDiv.classList.add('hidden');
                }
            });
        });
        
        // Select/Deselect all
        document.getElementById('select-all').addEventListener('click', function() {
            Object.values(categories).forEach(category => {
                category.items.forEach(item => {
                    category.layer.addLayer(item.marker);
                });
            });
            document.querySelectorAll('.category-header input[type="checkbox"]').forEach(cb => cb.checked = true);
            document.querySelectorAll('.item input[type="checkbox"]').forEach(cb => cb.checked = true);
        });
        
        document.getElementById('deselect-all').addEventListener('click', function() {
            Object.values(categories).forEach(category => {
                category.items.forEach(item => {
                    category.layer.removeLayer(item.marker);
                });
            });
            document.querySelectorAll('.category-header input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('.item input[type="checkbox"]').forEach(cb => cb.checked = false);
        });
        
        // Toggle labels
        document.getElementById('toggle-labels').addEventListener('click', function() {
            showLabels = !showLabels;
            this.textContent = showLabels ? 'Hide Labels' : 'Show Labels';
            this.classList.toggle('active', showLabels);
            updateMarkerLabels();
        });
        
        // Distance calculator
        function calculateWalkingTime(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            const miles = distance * 0.621371;
            const hours = miles / 3;
            const days = Math.floor(hours / 10);
            const remainingHours = Math.round(hours % 10);
            
            if (days > 0) {
                return {
                    walking: `${days} day${days > 1 ? 's' : ''}${remainingHours > 0 ? `, ${remainingHours} hr` : ''}`,
                    riding: `${Math.ceil(hours/2.5)} hours`,
                    distance: Math.round(miles)
                };
            } else if (hours < 1) {
                const minutes = Math.round(hours * 60);
                return {
                    walking: `${minutes} min`,
                    riding: `${Math.round(minutes/2.5)} min`,
                    distance: Math.round(miles * 10) / 10
                };
            } else {
                return {
                    walking: `${Math.round(hours)} hr`,
                    riding: `${Math.ceil(hours/2.5)} hr`,
                    distance: Math.round(miles)
                };
            }
        }
        
        document.getElementById('select-from').addEventListener('click', function() {
            selectingFrom = true;
            selectingTo = false;
            this.classList.add('active');
            document.getElementById('select-to').classList.remove('active');
            map.getContainer().style.cursor = 'crosshair';
        });
        
        document.getElementById('select-to').addEventListener('click', function() {
            selectingTo = true;
            selectingFrom = false;
            this.classList.add('active');
            document.getElementById('select-from').classList.remove('active');
            map.getContainer().style.cursor = 'crosshair';
        });
        
        document.getElementById('clear-selection').addEventListener('click', function() {
            selectingFrom = false;
            selectingTo = false;
            fromPoint = null;
            toPoint = null;
            
            if (fromMarker) map.removeLayer(fromMarker);
            if (toMarker) map.removeLayer(toMarker);
            if (pathLine) map.removeLayer(pathLine);
            
            fromMarker = null;
            toMarker = null;
            pathLine = null;
            
            document.getElementById('point-from').innerHTML = 'From: <em>Click "Select Start"</em>';
            document.getElementById('point-to').innerHTML = 'To: <em>Click "Select End"</em>';
            document.getElementById('distance-result').style.display = 'none';
            document.getElementById('select-from').classList.remove('active');
            document.getElementById('select-to').classList.remove('active');
            map.getContainer().style.cursor = '';
        });
        
        map.on('click', function(e) {
            if (selectingFrom) {
                if (fromMarker) map.removeLayer(fromMarker);
                fromPoint = e.latlng;
                fromMarker = L.marker(e.latlng, {icon: createEmojiIcon('üìç', 32)}).addTo(map);
                document.getElementById('point-from').innerHTML = `From: Selected`;
                selectingFrom = false;
                document.getElementById('select-from').classList.remove('active');
                map.getContainer().style.cursor = '';
                if (fromPoint && toPoint) updateDistance();
            } else if (selectingTo) {
                if (toMarker) map.removeLayer(toMarker);
                toPoint = e.latlng;
                toMarker = L.marker(e.latlng, {icon: createEmojiIcon('üéØ', 32)}).addTo(map);
                document.getElementById('point-to').innerHTML = `To: Selected`;
                selectingTo = false;
                document.getElementById('select-to').classList.remove('active');
                map.getContainer().style.cursor = '';
                if (fromPoint && toPoint) updateDistance();
            }
        });
        
        function updateDistance() {
            if (pathLine) map.removeLayer(pathLine);
            pathLine = L.polyline([fromPoint, toPoint], {
                color: '#ff6b6b', weight: 3, opacity: 0.8, dashArray: '10, 10'
            }).addTo(map);
            
            const time = calculateWalkingTime(
                fromPoint.lat, fromPoint.lng,
                toPoint.lat, toPoint.lng
            );
            
            document.getElementById('distance-result').innerHTML = `
                <strong>Distance:</strong> ~${time.distance} miles<br>
                <strong>üö∂ Walking:</strong> ${time.walking}<br>
                <strong>üêé Riding:</strong> ${time.riding}
            `;
            document.getElementById('distance-result').style.display = 'block';
        }
        
        // Default view
        map.fitBounds([[52.42, -2.0], [52.55, -1.8]]);
    </script>
</body>
</html>